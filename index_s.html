<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horoscope Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Astronomy Engine: Â§©‰ΩìË®àÁÆóÁî®„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                        serif: ['"Cormorant Garamond"', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* „Éô„Éº„Çπ„Çπ„Çø„Ç§„É´ */
        body { 
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* „ÉÅ„É£„Éº„Éà„Ç≥„É≥„ÉÜ„Éä: Ê≠£ÊñπÂΩ¢„ÇíÁ∂≠ÊåÅ */
        .chart-wrapper {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            aspect-ratio: 1 / 1;
        }
        canvas { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.1);
            background: white;
        }

        /* „Ç´„Çπ„Çø„É†„Çπ„Ç§„ÉÉ„ÉÅ */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0ea5e9;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0ea5e9;
        }
        
        /* „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÔºàÊ®™„Çπ„ÇØ„É≠„Éº„É´Áî®Ôºâ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ‰∏ãÈÉ®Âõ∫ÂÆöÊÉÖÂ†±„Éë„Éç„É´Ôºà„É¢„Éê„Ç§„É´Áî®Ôºâ */
        #mobile-info-toast {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateY(110%);
        }
        #mobile-info-toast.active {
            transform: translateY(0);
        }

        /* „Éê„ÉÉ„Ç∏„Çπ„Çø„Ç§„É´ */
        .lucky-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            white-space: nowrap;
        }
        .badge-tensha { background-color: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }
        .badge-ichiryu { background-color: #ecfccb; color: #15803d; border: 1px solid #bef264; }

        /* ÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÅÆÂæÆË™øÊï¥ */
        input[type="date"], input[type="time"] {
            appearance: none;
            -webkit-appearance: none;
            min-height: 44px; /* „Çø„ÉÉ„Éó„Åó„ÇÑ„Åô„ÅÑ„Çµ„Ç§„Ç∫ */
        }
    </style>
</head>
<body class="pb-24 lg:pb-10">

    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº -->
    <nav class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm px-4 py-3 flex justify-between items-center">
        <div>
            <h1 class="font-serif text-2xl font-bold text-slate-800 tracking-tight leading-none">Horoscope</h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-0.5">Generator</p>
        </div>
        <button id="openSettingsBtn" class="p-2 -mr-2 text-slate-500 hover:text-brand-600 active:bg-slate-100 rounded-full transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
    </nav>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="max-w-6xl mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Â∑¶„Ç´„É©„É† / ‰∏äÈÉ®: „ÉÅ„É£„Éº„Éà„Å®„Ç≥„É≥„Éà„É≠„Éº„É©„Éº -->
        <div class="lg:col-span-7 xl:col-span-8 space-y-6">
            
            <!-- „ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢ -->
            <div class="bg-slate-100 rounded-3xl p-1 lg:p-4 shadow-inner">
                <div class="chart-wrapper">
                    <canvas id="horoscopeCanvas"></canvas>
                    
                    <!-- „ÉÅ„É£„Éº„ÉàÂÜÖÊÉÖÂ†±„Ç™„Éº„Éê„Éº„É¨„Ç§ (ASC„Å™„Å©) -->
                    <div class="absolute top-2 left-2 bg-white/80 backdrop-blur px-3 py-1 rounded-full border border-slate-200 shadow-sm pointer-events-none">
                        <span id="ascendant-overlay" class="text-xs font-bold text-slate-700 font-mono">ASC: --</span>
                    </div>
                </div>
            </div>

            <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ („Ç´„Éº„ÉâÂΩ¢Âºè) -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 px-4 py-2 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-xs font-bold uppercase tracking-wider text-slate-500 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Chart Controls
                    </span>
                    <button id="setNowBtn" class="text-[10px] bg-brand-50 text-brand-600 border border-brand-200 px-3 py-1 rounded-full font-bold uppercase hover:bg-brand-100 active:scale-95 transition">
                        Now
                    </button>
                </div>
                
                <div class="p-4 grid grid-cols-2 gap-3 md:gap-4">
                    <!-- Êó•‰ªò -->
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Date</label>
                        <input type="date" id="targetDate" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm font-bold rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition shadow-sm">
                    </div>
                    <!-- ÊôÇÂàª -->
                    <div class="col-span-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Time</label>
                        <div class="flex gap-2">
                            <input type="time" id="targetTime" class="flex-1 bg-slate-50 border border-slate-200 text-slate-800 text-sm font-bold rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500 shadow-sm">
                            <button id="togglePlayBtn" class="w-10 flex-shrink-0 bg-slate-100 border border-slate-200 text-brand-600 rounded-lg flex items-center justify-center hover:bg-slate-200 active:bg-slate-300 transition">
                                <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                <svg id="icon-pause" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Â†¥ÊâÄ -->
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Location</label>
                        <div class="relative">
                            <select id="citySelect" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm font-bold rounded-lg px-3 py-2 appearance-none focus:outline-none focus:ring-2 focus:ring-brand-500 shadow-sm"></select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>

                    <!-- Â∫ßÊ®ôË©≥Á¥∞ÔºàÊäò„Çä„Åü„Åü„ÅøÂèØËÉΩ„Åæ„Åü„ÅØÊâãÂãïÊôÇ„ÅÆ„ÅøÈáçË¶ÅÔºâ -->
                    <div class="col-span-2 md:col-span-1 flex gap-2">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Lat</label>
                            <input type="number" id="lat" step="0.01" class="w-full bg-slate-50 border border-slate-200 text-slate-600 text-sm font-mono rounded-lg px-2 py-2 text-center" value="35.01">
                        </div>
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Lon</label>
                            <input type="number" id="lon" step="0.01" class="w-full bg-slate-50 border border-slate-200 text-slate-600 text-sm font-mono rounded-lg px-2 py-2 text-center" value="135.76">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âè≥„Ç´„É©„É† / ‰∏ãÈÉ®: ÊÉÖÂ†±„Ç´„Éº„ÉâÁæ§ -->
        <div class="lg:col-span-5 xl:col-span-4 space-y-6">
            
            <!-- „Çø„ÉñÂàá„ÇäÊõø„ÅàÈ¢®„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÔºà„É¢„Éê„Ç§„É´„Åß„ÅØÁ∏¶Á©ç„ÅøÔºâ -->
            
            <!-- 1. Êó•Êú¨„ÅÆÊö¶ -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-gradient-to-r from-amber-50 to-white px-4 py-2 border-b border-amber-100">
                    <span class="text-xs font-bold text-amber-800 uppercase tracking-widest flex items-center gap-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Calendar
                    </span>
                </div>
                <div class="p-4">
                    <div id="luckyDayArea" class="mb-3 flex flex-wrap gap-2 min-h-[24px]"></div>
                    <div class="grid grid-cols-2 gap-3 text-sm" id="japanCalendarGrid"></div>
                </div>
            </div>

            <!-- 2. Â§©‰Ωì‰ΩçÁΩÆ„É™„Çπ„Éà -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                 <div class="bg-slate-50 px-4 py-2 border-b border-slate-100">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Planetary Positions</span>
                </div>
                <div id="planetList" class="divide-y divide-slate-50 max-h-60 overflow-y-auto"></div>
            </div>

            <!-- 3. „Ç¢„Çπ„Éö„ÇØ„Éà„É™„Çπ„Éà -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-12">
                 <div class="bg-slate-50 px-4 py-2 border-b border-slate-100 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-widest">Aspects</span>
                    <span class="text-[10px] text-slate-400">Tap chart to hide/show</span>
                </div>
                <div id="aspectResults" class="p-2 grid grid-cols-2 sm:grid-cols-3 gap-2 text-xs"></div>
            </div>
        </div>
    </main>

    <!-- „É¢„Éê„Ç§„É´Áî®„Éà„Éº„Çπ„ÉàÈÄöÁü• (Â§©‰Ωì„Çø„ÉÉ„ÉóÊôÇ„Å´Ë°®Á§∫) -->
    <div id="mobile-info-toast" class="fixed bottom-4 left-4 right-4 bg-white/95 backdrop-blur shadow-2xl rounded-2xl p-4 border border-slate-200 z-50 flex flex-col items-center text-center">
        <div class="w-10 h-1 bg-slate-200 rounded-full mb-3"></div>
        <div id="toast-content" class="w-full"></div>
    </div>

    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center sm:p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl overflow-hidden transform transition-all">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800" id="label-settings-modal">Settings</h3>
                <button id="closeSettingsBtn" class="text-slate-400 hover:text-slate-700 p-2 bg-slate-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
                <!-- „Çø„Ç§„É†„Çæ„Éº„É≥ -->
                <div>
                    <label id="label-tz-modal" class="block text-xs uppercase tracking-widest font-bold text-slate-500 mb-2">Timezone</label>
                    <div class="relative">
                        <select id="timezone" class="w-full p-3 pl-4 border border-slate-200 rounded-xl bg-slate-50 font-bold text-slate-700 outline-none appearance-none"></select>
                         <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>

                <!-- „ÉÅ„É£„Éº„ÉàÂõûËª¢ -->
                <div>
                    <label id="label-rotation" class="block text-xs uppercase tracking-widest font-bold text-slate-500 mb-2">Chart Rotation</label>
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button class="flex-1 py-2 text-xs font-bold rounded-md shadow-sm bg-white text-slate-800 transition" id="rot-aries-btn" onclick="setRotation('aries')">Aries 0¬∞</button>
                        <button class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition" id="rot-asc-btn" onclick="setRotation('asc')">ASC</button>
                    </div>
                </div>

                <!-- Ë°®Á§∫„Ç™„Éó„Ç∑„Éß„É≥ -->
                <div class="space-y-4 pt-2">
                    <div class="flex items-center justify-between">
                        <span id="label-show-asc-line" class="text-sm font-bold text-slate-700">Show ASC Line</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="toggleAscLine" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 border-slate-200 appearance-none cursor-pointer transition-all duration-300"/>
                            <label for="toggleAscLine" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer"></label>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Aspect Visibility</p>
                        <div id="aspect-toggles" class="space-y-3"></div>
                    </div>
                </div>
                
                <!-- Ë®ÄË™ûÂàá„ÇäÊõø„Åà -->
                <div class="pt-2">
                    <button id="langToggle" class="w-full py-3 bg-white border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 active:bg-slate-100 transition shadow-sm flex justify-center gap-2 items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                        English / Êó•Êú¨Ë™û
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ÂÆöÊï∞„Éª„Éá„Éº„ÇøÂÆöÁæ© ---
        const J_ETO_KAN = ["Áî≤", "‰πô", "‰∏ô", "‰∏Å", "Êàä", "Â∑±", "Â∫ö", "Ëæõ", "Â£¨", "Áô∏"];
        const J_ETO_SHI = ["Â≠ê", "‰∏ë", "ÂØÖ", "ÂçØ", "Ëæ∞", "Â∑≥", "Âçà", "Êú™", "Áî≥", "ÈÖâ", "Êàå", "‰∫•"];
        const J_ROKUYO = ["Â§ßÂÆâ", "Ëµ§Âè£", "ÂÖàÂãù", "ÂèãÂºï", "ÂÖàË≤†", "‰ªèÊªÖ"];
        const J_CHOKU = ["Âª∫", "Èô§", "Ê∫Ä", "Âπ≥", "ÂÆö", "Âü∑", "Á†¥", "Âç±", "Êàê", "Á¥ç", "Èñã", "Èñâ"]; 

        const ELEMENT_COLORS = { Fire: "#fff7ed", Earth: "#f0fdf4", Air: "#f8fafc", Water: "#eff6ff" };
        const SIGN_ELEMENTS = ["Fire", "Earth", "Air", "Water", "Fire", "Earth", "Air", "Water", "Fire", "Earth", "Air", "Water"];

        const TIMEZONES = [
            { name: "(UTC-08:00) Pacific", offset: -8 }, { name: "(UTC-05:00) Eastern", offset: -5 },
            { name: "(UTC+00:00) London", offset: 0 }, { name: "(UTC+01:00) Paris", offset: 1 }, { name: "(UTC+09:00) Tokyo", offset: 9 },
        ];

        const CITY_DATA = [
            { id: "manual", nameJa: "ÊâãÂãïÂÖ•Âäõ", nameEn: "Manual", lat: null, lon: null },
            { id: "tokyo", nameJa: "Êù±‰∫¨", nameEn: "Tokyo", lat: 35.68, lon: 139.76 },
            { id: "kyoto", nameJa: "‰∫¨ÈÉΩ", nameEn: "Kyoto", lat: 35.01, lon: 135.76 },
            { id: "osaka", nameJa: "Â§ßÈò™", nameEn: "Osaka", lat: 34.69, lon: 135.50 },
            { id: "sapporo", nameJa: "Êú≠Âπå", nameEn: "Sapporo", lat: 43.06, lon: 141.35 },
            { id: "fukuoka", nameJa: "Á¶èÂ≤°", nameEn: "Fukuoka", lat: 33.59, lon: 130.40 },
            { id: "ny", nameJa: "New York", nameEn: "New York", lat: 40.71, lon: -74.00 },
            { id: "london", nameJa: "London", nameEn: "London", lat: 51.50, lon: -0.12 }
        ];

        const i18n = {
            ja: {
                title: "Horoscope", labelDateTime: "Êó•ÊôÇ", labelTz: "„Çø„Ç§„É†„Çæ„Éº„É≥", labelSettingsModal: "Ë®≠ÂÆö", labelRotation: "„ÉÅ„É£„Éº„ÉàÂõûËª¢Âü∫Ê∫ñ", labelShowAscLine: "ASC„É©„Ç§„É≥Ë°®Á§∫", labelCity: "ÈÉΩÂ∏Ç", labelLat: "Á∑ØÂ∫¶", labelLon: "ÁµåÂ∫¶", setNow: "ÁèæÂú®", dataHeader: "Â§©‰Ωì‰ΩçÁΩÆ", aspectHeader: "„Ç¢„Çπ„Éö„ÇØ„Éà", noAspects: "„Ç¢„Çπ„Éö„ÇØ„Éà„Å™„Åó", labelSettings: "Ë®≠ÂÆö", orb: "Ë®±ÂÆπ", asc: "ASC", labelJpCalendar: "Êó•Êú¨„ÅÆÊö¶", lblKyuureki: "ÊóßÊö¶", lblRokuyo: "ÂÖ≠Êõú", lblEto: "Êó•Âπ≤ÊîØ", lblChoku: "ÂçÅ‰∫åÁõ¥",
                planets: { Sun: "Â§™ÈôΩ", Moon: "Êúà", Mercury: "Ê∞¥Êòü", Venus: "ÈáëÊòü", Mars: "ÁÅ´Êòü", Jupiter: "Êú®Êòü", Saturn: "ÂúüÊòü", Uranus: "Â§©ÁéãÊòü", Neptune: "Êµ∑ÁéãÊòü", Pluto: "ÂÜ•ÁéãÊòü", Ceres: "„Ç±„É¨„Çπ", Pallas: "„Éë„É©„Çπ", Juno: "„Ç∏„É•„Éé„Éº", Vesta: "„Éô„Çπ„Çø", Chiron: "„Ç≠„É≠„É≥" },
                signs: ["Áâ°ÁæäÂ∫ß", "Áâ°ÁâõÂ∫ß", "ÂèåÂ≠êÂ∫ß", "ËüπÂ∫ß", "ÁçÖÂ≠êÂ∫ß", "‰πôÂ•≥Â∫ß", "Â§©Áß§Â∫ß", "Ë†çÂ∫ß", "Â∞ÑÊâãÂ∫ß", "Â±±ÁæäÂ∫ß", "Ê∞¥Áì∂Â∫ß", "È≠öÂ∫ß"],
                aspectNames: { Conjunction: "Âêà(0¬∞)", Opposition: "Ë°ù(180¬∞)", Trine: "‰∏âÂàÜ(120¬∞)", Square: "ÂõõÂàÜ(90¬∞)", Sextile: "ÂÖ≠ÂàÜ(60¬∞)" }
            },
            en: {
                title: "Horoscope", labelDateTime: "Date & Time", labelTz: "Timezone", labelSettingsModal: "Settings", labelRotation: "Rotation", labelShowAscLine: "Show ASC Line", labelCity: "City", labelLat: "Lat", labelLon: "Lon", setNow: "NOW", dataHeader: "Positions", aspectHeader: "Aspects", noAspects: "None.", labelSettings: "Settings", orb: "orb", asc: "ASC", labelJpCalendar: "Calendar", lblKyuureki: "Lunar", lblRokuyo: "Rokuyo", lblEto: "Eto", lblChoku: "Choku",
                planets: { Sun: "Sun", Moon: "Moon", Mercury: "Mercury", Venus: "Venus", Mars: "Mars", Jupiter: "Jupiter", Saturn: "Saturn", Uranus: "Uranus", Neptune: "Neptune", Pluto: "Pluto", Ceres: "Ceres", Pallas: "Pallas", Juno: "Juno", Vesta: "Vesta", Chiron: "Chiron" },
                signs: ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"],
                aspectNames: { Conjunction: "Conj", Opposition: "Opp", Trine: "Trine", Square: "Square", Sextile: "Sextile" }
            }
        };

        let currentLang = 'ja', chartRotationMode = 'aries', showAscLine = true;
        let aspectVisibility = { Conjunction: false, Opposition: true, Trine: true, Square: true, Sextile: false };
        
        const PLANET_DEFS = [
            { id: "Sun", symbol: "‚òâ", color: "#b45309" }, { id: "Moon", symbol: "‚òΩ", color: "#475569" }, 
            { id: "Mercury", symbol: "‚òø", color: "#0f766e" }, { id: "Venus", symbol: "‚ôÄ", color: "#be185d" }, 
            { id: "Mars", symbol: "‚ôÇ", color: "#b91c1c" }, { id: "Ceres", symbol: "‚ö≥", color: "#854d0e" }, 
            { id: "Pallas", symbol: "‚ö¥", color: "#0369a1" }, { id: "Juno", symbol: "‚öµ", color: "#be185d" }, 
            { id: "Vesta", symbol: "‚ö∂", color: "#b91c1c" }, { id: "Jupiter", symbol: "‚ôÉ", color: "#7e22ce" }, 
            { id: "Saturn", symbol: "‚ôÑ", color: "#334155" }, { id: "Chiron", symbol: "‚ö∑", color: "#0f766e" },
            { id: "Uranus", symbol: "‚ôÖ", color: "#0369a1" }, { id: "Neptune", symbol: "‚ôÜ", color: "#1d4ed8" }, 
            { id: "Pluto", symbol: "‚ôá", color: "#1e1b4b" }
        ];

        const ASPECT_DEFS = [
            { id: "Conjunction", angle: 0, orb: 8, color: "#2563eb" }, { id: "Opposition", angle: 180, orb: 8, color: "#dc2626" },
            { id: "Trine", angle: 120, orb: 8, color: "#2563eb" }, { id: "Square", angle: 90, orb: 7, color: "#dc2626" },
            { id: "Sextile", angle: 60, orb: 6, color: "#2563eb" }
        ];

        const ZODIAC_PATHS = ["M12 21V10 M6 9c0 4.5 6 3 6-1 0 4 6 5.5 6 1", "M12 21V10 M12 10a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M5 6c0-3 3-4 7-4s7 1 7 4", "M6 4v16 M18 4v16 M6 4c6 2 12 0 12 0 M6 20c6-2 12 0 12 0", "M6 6c6 0 6 9 0 9s-6-9 0-9 M18 18c-6 0-6-9 0-9s6 9 0 9", "M6 18c0-4 2-6 6-6 4 0 6-3 6-6s-2-4-4-4-3 1-3 3 M18 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4", "M5 6c3 0 3 5 3 5s0-5 3-5 3 5 3 5v7c0 2-2 4-5 0 M14 11c0 3 3 4 4 0", "M5 19h14 M5 15h14 M12 15a4 4 0 0 1 0-8 4 4 0 0 1 0 8", "M6 6v8c0 3 3 3 3 0v-8c0 3 3 3 3 0v8c0 3 3 3 3 0v2l3 3", "M7 17l10-10 M17 7v5 M17 7h-5 M4 20l4-4", "M4 15a3 3 0 0 1 3-3h.5a2.5 2.5 0 0 1 2.5 2.5V17a3.5 3.5 0 0 0 3.5 3.5h.5a3 3 0 0 0 3-3c0-3-2.5-4-5-4v-3a5 5 0 0 0-5-5h-.5a5.5 5.5 0 0 0-5.5 5.5V18", "M4 10l3-3 3 3 3-3 3 3 3-3 M4 16l3-3 3 3 3-3 3 3 3-3", "M6 6c4 4 4 8 0 12 M18 6c-4 4-4 8 0 12 M5 12h14"];
        const ASTEROID_ELEMENTS = { "Ceres": { a: 2.766, e: 0.0758, i: 10.59, N: 80.33, w: 73.51, M: 77.37 }, "Pallas": { a: 2.773, e: 0.231, i: 34.84, N: 173.08, w: 310.05, M: 96.98 }, "Juno": { a: 2.670, e: 0.255, i: 12.97, N: 169.85, w: 248.42, M: 41.53 }, "Vesta": { a: 2.362, e: 0.0886, i: 7.14, N: 103.81, w: 151.20, M: 20.85 }, "Chiron": { a: 13.70, e: 0.383, i: 6.93, N: 209.32, w: 339.56, M: 8.5 } };

        let planetData = [], ascendantDeg = 0, hitZones = [], isPlaying = false, animationFrameId = null, lastTimestamp = 0;

        // --- ÂàùÊúüÂåñ ---
        window.onload = () => {
            const canvas = document.getElementById('horoscopeCanvas');
            initTimezoneSelect(); setNow(); initCitySelect(); renderAspectToggles(); updateStaticLabels(); initRealtimeUpdates();
            
            function resizeCanvas() { 
                const container = canvas.parentElement;
                canvas.width = container.clientWidth * window.devicePixelRatio; 
                canvas.height = container.clientWidth * window.devicePixelRatio; 
                if (planetData.length > 0) drawChart(); 
            }
            window.addEventListener('resize', resizeCanvas); 
            resizeCanvas();
            
            // Touch & Mouse Events
            canvas.addEventListener('click', handleCanvasTap);
            
            document.getElementById('setNowBtn').onclick = () => { setNow(); calculateHoroscope(); };
            document.getElementById('togglePlayBtn').onclick = togglePlay;
            document.getElementById('langToggle').onclick = toggleLanguage;
            
            // Modal Controls
            document.getElementById('openSettingsBtn').onclick = () => document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('closeSettingsBtn').onclick = () => document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').addEventListener('click', (e) => {
                if(e.target === document.getElementById('settingsModal')) document.getElementById('settingsModal').classList.add('hidden');
            });

            document.getElementById('timezone').onchange = (e) => { calculateHoroscope(); };
            
            // ÂàùÊúüË®àÁÆó
            calculateHoroscope();
        };

        function setText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }

        function updateStaticLabels() {
            const t = i18n[currentLang];
            // Á∞°Áï•Âåñ„ÅÆ„Åü„ÇÅ‰∏ª„Å™„É©„Éô„É´„ÅÆ„ÅøÊõ¥Êñ∞
            setText('label-settings-modal', t.labelSettingsModal); 
            setText('label-rotation', t.labelRotation); 
            setText('label-show-asc-line', t.labelShowAscLine); 
            updateCityOptions();
        }

        function setRotation(mode) {
            chartRotationMode = mode;
            // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            const btnAries = document.getElementById('rot-aries-btn');
            const btnAsc = document.getElementById('rot-asc-btn');
            if(mode === 'aries') {
                btnAries.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                btnAries.classList.remove('text-slate-500');
                btnAsc.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btnAsc.classList.add('text-slate-500');
            } else {
                btnAsc.classList.add('bg-white', 'text-slate-800', 'shadow-sm');
                btnAsc.classList.remove('text-slate-500');
                btnAries.classList.remove('bg-white', 'text-slate-800', 'shadow-sm');
                btnAries.classList.add('text-slate-500');
            }
            drawChart();
        }

        function updateJapanCalendar(astroTime, sunLon) {
            const jd = astroTime.ut + 2451545.0, dayIndex = Math.floor(jd + 0.5), etoIdx = (dayIndex + 49) % 60;
            const dayEtoStr = `${J_ETO_KAN[etoIdx % 10]}${J_ETO_SHI[etoIdx % 12]}`;
            let adj = (sunLon - 315 + 360) % 360;
            const setsuIdx = Math.floor(adj / 30);
            const chokuStr = J_CHOKU[(etoIdx % 12 - (setsuIdx + 2) % 12 + 12) % 12];
            const nm = Astronomy.SearchMoonPhase(0, astroTime, -35); if (!nm) return;
            const lDay = Math.floor(astroTime.ut - nm.ut) + 1, lMonth = Math.floor(((Astronomy.SunPosition(nm).elon - 330 + 360) % 360) / 30) + 1;
            
            let lucky = "";
            const s = Math.floor(setsuIdx / 3); 
            if ((s===0 && dayEtoStr==="ÊàäÂØÖ") || (s===1 && dayEtoStr==="Áî≤Âçà") || (s===2 && dayEtoStr==="ÊàäÁî≥") || (s===3 && dayEtoStr==="Áî≤Â≠ê")) lucky += `<span class="lucky-badge badge-tensha">‚òÖ Â§©Ëµ¶Êó•</span>`;
            
            const manbaiMap = [["‰∏ë","Âçà"],["ÂØÖ","ÈÖâ"],["Â≠ê","ÂçØ"],["ÂçØ","Ëæ∞"],["Â∑≥","Âçà"],["Âçà","ÈÖâ"],["Â≠ê","Êú™"],["ÂçØ","Áî≥"],["ÈÖâ","Âçà"],["ÈÖâ","Êàå"],["‰∫•","Â≠ê"],["Â≠ê","‰∏ë"]];
            if (manbaiMap[setsuIdx].includes(J_ETO_SHI[etoIdx % 12])) lucky += `<span class="lucky-badge badge-ichiryu">üåæ ‰∏ÄÁ≤í‰∏áÂÄçÊó•</span>`;
            
            document.getElementById('luckyDayArea').innerHTML = lucky || `<span class="text-xs text-slate-400">-</span>`;
            
            // „Ç∑„É≥„Éó„É´„Å™„Ç∞„É™„ÉÉ„ÉâË°®Á§∫
            document.getElementById('japanCalendarGrid').innerHTML = `
                <div class="flex flex-col bg-slate-50 p-2 rounded border border-slate-100">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">${i18n[currentLang].lblRokuyo} / ${i18n[currentLang].lblKyuureki}</span>
                    <span class="font-bold text-slate-700">${J_ROKUYO[(lMonth + lDay) % 6]} <span class="text-slate-400 mx-1">/</span> ${lMonth}/${lDay}</span>
                </div>
                <div class="flex flex-col bg-slate-50 p-2 rounded border border-slate-100">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">${i18n[currentLang].lblEto} / ${i18n[currentLang].lblChoku}</span>
                    <span class="font-bold text-slate-700">${dayEtoStr} <span class="text-slate-400 mx-1">/</span> ${chokuStr}</span>
                </div>
            `;
        }

        function drawChart() {
            const canvas = document.getElementById('horoscopeCanvas'), ctx = canvas.getContext('2d');
            const size = canvas.width / window.devicePixelRatio;
            // DPRË£úÊ≠£
            ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
            
            const center = size / 2;
            const outerRadius = size * 0.49, midRadius = outerRadius * 0.93, innerRadius = midRadius * 0.85;
            const t = i18n[currentLang], fontSans = '"Noto Sans JP", sans-serif';
            let rotBase = chartRotationMode === 'asc' ? ascendantDeg * Math.PI / 180 : 0; 
            
            ctx.clearRect(0, 0, size, size); hitZones = [];

            // ÊòüÂ∫ß„É™„É≥„Ç∞ËÉåÊôØ
            for (let i = 0; i < 12; i++) {
                const startA = Math.PI - (i * 30 * Math.PI / 180 - rotBase), endA = Math.PI - ((i + 1) * 30 * Math.PI / 180 - rotBase);
                ctx.beginPath(); ctx.moveTo(center, center); ctx.arc(center, center, midRadius, startA, endA, true);
                ctx.fillStyle = ELEMENT_COLORS[SIGN_ELEMENTS[i]]; ctx.fill();
            }
            // ÂÜÖÂÅ¥„ÅÆÁôΩÂÜÜ
            ctx.beginPath(); ctx.arc(center, center, innerRadius, 0, Math.PI * 2); ctx.fillStyle = "#ffffff"; ctx.fill();

            const pOrder = { "Sun": 0, "Mercury": 1, "Venus": 2, "Moon": 3, "Mars": 4, "Ceres": 4.8, "Pallas": 4.9, "Juno": 5.0, "Vesta": 5.1, "Jupiter": 6, "Saturn": 7, "Chiron": 7.5, "Uranus": 8, "Neptune": 9, "Pluto": 10 };
            const orbMaxR = innerRadius * 0.92, orbMinR = innerRadius * 0.20;
            
            // ËªåÈÅì„Ç¨„Ç§„ÉâÂÜÜ
            ctx.lineWidth = 0.5; ctx.strokeStyle = '#f1f5f9'; 
            for (let i = 0; i <= 10; i++) { ctx.beginPath(); ctx.arc(center, center, orbMinR + (i / 10) * (orbMaxR - orbMinR), 0, Math.PI * 2); ctx.stroke(); }

            // ÊòüÂ∫ßÂ¢ÉÁïåÁ∑ö„Å®„É©„Éô„É´
            for (let i = 0; i < 12; i++) {
                const angle = Math.PI - (i * 30 * Math.PI / 180 - rotBase);
                ctx.beginPath(); ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1; ctx.moveTo(center + Math.cos(angle) * midRadius, center + Math.sin(angle) * midRadius); ctx.lineTo(center + Math.cos(angle) * (orbMinR * 0.8), center + Math.sin(angle) * (orbMinR * 0.8)); ctx.stroke();
                
                const midA = Math.PI - ((i * 30 + 15) * Math.PI / 180 - rotBase);
                const hNum = (i - Math.floor(ascendantDeg / 30) + 12) % 12 + 1;
                
                ctx.save(); ctx.translate(center, center); ctx.rotate(midA + Math.PI / 2);
                
                // ÊòüÂ∫ßÂêç (Â∞ë„ÅóÂ∞è„Åï„Åè)
                ctx.fillStyle = '#64748b'; ctx.font = `bold 10px ${fontSans}`; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom'; 
                ctx.fillText(`${t.signs[i]}`, 0, -midRadius + 4); // ‰ΩçÁΩÆË™øÊï¥
                
                // ÊòüÂ∫ßË®òÂè∑
                ctx.translate(0, -(innerRadius + (midRadius - innerRadius)/2)); ctx.scale(1.0, 1.0); ctx.translate(-12, -12);
                ctx.strokeStyle = '#475569'; ctx.lineWidth = 1.5; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke(new Path2D(ZODIAC_PATHS[i])); ctx.restore();
            }

            // ASC„É©„Ç§„É≥
            if (showAscLine) {
                const adA = Math.PI - (ascendantDeg * Math.PI / 180 - rotBase);
                ctx.beginPath(); ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2; ctx.moveTo(center + Math.cos(adA) * innerRadius, center + Math.sin(adA) * innerRadius); ctx.lineTo(center + Math.cos(adA + Math.PI) * innerRadius, center + Math.sin(adA + Math.PI) * innerRadius); ctx.stroke();
            }

            // „Ç¢„Çπ„Éö„ÇØ„ÉàÁ∑ö
            const mR = innerRadius * 0.98; ctx.globalAlpha = 0.6;
            for (let i = 0; i < planetData.length; i++) { for (let j = i + 1; j < planetData.length; j++) {
                const p1 = planetData[i], p2 = planetData[j]; 
                if(["Ceres","Pallas","Juno","Vesta"].includes(p1.id) || ["Ceres","Pallas","Juno","Vesta"].includes(p2.id)) continue;
                ASPECT_DEFS.forEach(asp => {
                    if (!aspectVisibility[asp.id]) return;
                    const diff = Math.abs(p1.longitude - p2.longitude), orb = Math.abs((diff > 180 ? 360 - diff : diff) - asp.angle);
                    if (orb <= asp.orb) {
                        const a1 = Math.PI - (p1.longitude * Math.PI / 180 - rotBase), a2 = Math.PI - (p2.longitude * Math.PI / 180 - rotBase);
                        ctx.beginPath(); ctx.lineWidth = orb < 1 ? 2 : 1; ctx.strokeStyle = asp.color; ctx.moveTo(center + Math.cos(a1) * mR, center + Math.sin(a1) * mR); ctx.lineTo(center + Math.cos(a2) * mR, center + Math.sin(a2) * mR); ctx.stroke();
                    }
                });
            } } ctx.globalAlpha = 1.0;

            // Â§©‰ΩìÈÖçÁΩÆ
            planetData.forEach(p => {
                const angle = Math.PI - (p.longitude * Math.PI / 180 - rotBase);
                const mx = center + Math.cos(angle) * mR, my = center + Math.sin(angle) * mR, sx = center + Math.cos(angle) * (orbMinR + ((pOrder[p.id] || 0) / 10) * (orbMaxR - orbMinR)), sy = center + Math.sin(angle) * (orbMinR + ((pOrder[p.id] || 0) / 10) * (orbMaxR - orbMinR));
                
                // „Ç¨„Ç§„ÉâÁ∑ö
                ctx.beginPath(); ctx.strokeStyle = p.color; ctx.lineWidth = 0.5; ctx.setLineDash([2, 2]); ctx.moveTo(mx, my); ctx.lineTo(sx, sy); ctx.stroke(); ctx.setLineDash([]);
                
                // Â§ñÁ∏Å„ÅÆÁÇπ
                ctx.beginPath(); ctx.fillStyle = p.color; ctx.arc(mx, my, 2, 0, Math.PI * 2); ctx.fill();
                
                // Â§©‰Ωì„Ç¢„Ç§„Ç≥„É≥ËÉåÊôØ
                ctx.beginPath(); ctx.arc(sx, sy, 10, 0, Math.PI * 2); ctx.fillStyle = "rgba(255,255,255,0.95)"; ctx.fill();
                ctx.strokeStyle = p.color; ctx.lineWidth = 1; ctx.stroke();

                // Â§©‰ΩìË®òÂè∑
                ctx.fillStyle = p.color; ctx.font = `400 18px ${fontSans}`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(p.symbol, sx, sy + 1);
                
                // „Çø„ÉÉ„ÉóÂà§ÂÆöÈ†òÂüü (Â∞ë„ÅóÂ§ß„Åç„ÇÅ„Å´)
                hitZones.push({ x: sx, y: sy, r: 20, data: p });
            });
        }

        // --- UI & Logic ---
        function initTimezoneSelect() { document.getElementById('timezone').innerHTML = TIMEZONES.map(tz => `<option value="${tz.offset}" ${tz.offset === 9 ? 'selected' : ''}>${tz.name}</option>`).join(''); }
        function initRealtimeUpdates() { 
            ['targetDate', 'targetTime', 'lat', 'lon'].forEach(id => document.getElementById(id).addEventListener('input', () => { 
                if (id === 'lat' || id === 'lon') document.getElementById('citySelect').value = "manual"; 
                calculateHoroscope(); 
            })); 
            document.getElementById('toggleAscLine').onchange = (e) => { showAscLine = e.target.checked; drawChart(); }; 
        }
        function initCitySelect() { const s = document.getElementById('citySelect'); updateCityOptions(); s.value = "tokyo"; s.onchange = (e) => { const c = CITY_DATA.find(x => x.id === e.target.value); if (c && c.lat !== null) { document.getElementById('lat').value = c.lat; document.getElementById('lon').value = c.lon; calculateHoroscope(); } }; }
        function updateCityOptions() { document.getElementById('citySelect').innerHTML = CITY_DATA.map(c => `<option value="${c.id}">${currentLang === 'ja' ? c.nameJa : c.nameEn}</option>`).join(''); }
        
        function renderAspectToggles() { 
            const c = document.getElementById('aspect-toggles'), t = i18n[currentLang]; 
            c.innerHTML = ASPECT_DEFS.map(asp => `
                <div class="flex items-center justify-between">
                    <span class="text-xs font-bold text-slate-700">${t.aspectNames[asp.id]}</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="toggle-${asp.id}" ${aspectVisibility[asp.id] ? 'checked' : ''} class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 border-slate-200 appearance-none cursor-pointer transition-all duration-300"/>
                        <label for="toggle-${asp.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer"></label>
                    </div>
                </div>
            `).join(''); 
            ASPECT_DEFS.forEach(asp => { document.getElementById(`toggle-${asp.id}`).onchange = (e) => { aspectVisibility[asp.id] = e.target.checked; calculateHoroscope(); }; }); 
        }
        
        function toggleLanguage() { currentLang = currentLang === 'ja' ? 'en' : 'ja'; updateStaticLabels(); updateCityOptions(); renderAspectToggles(); updateUI(); drawChart(); }
        function setNow() { const n = new Date(), o = parseFloat(document.getElementById('timezone').value) || 0, d = new Date(n.getTime() + (o * 3600000)); document.getElementById('targetDate').value = d.toISOString().split('T')[0]; document.getElementById('targetTime').value = d.toISOString().split('T')[1].substring(0, 5); }
        
        function togglePlay() { 
            isPlaying = !isPlaying; const b = document.getElementById('togglePlayBtn'); 
            if (isPlaying) { 
                b.classList.add('bg-brand-50', 'text-brand-600', 'border-brand-200');
                document.getElementById('icon-play').classList.add('hidden'); 
                document.getElementById('icon-pause').classList.remove('hidden'); 
                lastTimestamp = performance.now(); animationFrameId = requestAnimationFrame(animate); 
            } else { 
                b.classList.remove('bg-brand-50', 'text-brand-600', 'border-brand-200');
                document.getElementById('icon-play').classList.remove('hidden'); 
                document.getElementById('icon-pause').classList.add('hidden'); 
                if (animationFrameId) cancelAnimationFrame(animationFrameId); 
            } 
        }
        function animate(t) { if (!isPlaying) return; const d = t - (lastTimestamp || t); lastTimestamp = t; const c = new Date(`${document.getElementById('targetDate').value}T${document.getElementById('targetTime').value}:00Z`).getTime(); if (!isNaN(c)) { const nt = new Date(c + d * 86400 * 2); /* ÂÄçÈÄü */ document.getElementById('targetDate').value = nt.toISOString().split('T')[0]; document.getElementById('targetTime').value = nt.toISOString().split('T')[1].substring(0, 5); calculateHoroscope(); } animationFrameId = requestAnimationFrame(animate); }

        // „É¢„Éê„Ç§„É´„Éï„É¨„É≥„Éâ„É™„Éº„Å™„Çø„ÉÉ„Éó„Éè„É≥„Éâ„É©
        function handleCanvasTap(e) {
            const c = document.getElementById('horoscopeCanvas'), rect = c.getBoundingClientRect();
            // Â∫ßÊ®ôÂ§âÊèõ (CSS„Çµ„Ç§„Ç∫„Å®CanvasËß£ÂÉèÂ∫¶„ÅÆÈÅï„ÅÑ„ÇíËÄÉÊÖÆ)
            const x = (e.clientX - rect.left) * (c.width / rect.width / window.devicePixelRatio);
            const y = (e.clientY - rect.top) * (c.height / rect.height / window.devicePixelRatio);
            
            const toast = document.getElementById('mobile-info-toast');
            let found = false;

            for (const z of hitZones) { 
                if (Math.sqrt((x - z.x)**2 + (y - z.y)**2) <= z.r * 1.5) { // „Çø„ÉÉ„ÉóÂà§ÂÆö„ÇíÂ∞ë„ÅóÁîò„Åè
                    found = true; 
                    const pl = z.data, lang = i18n[currentLang]; 
                    const hs = (Math.floor(pl.longitude / 30) - Math.floor(ascendantDeg / 30) + 12) % 12 + 1; 
                    
                    document.getElementById('toast-content').innerHTML = `
                        <h4 class="text-lg font-bold text-slate-800 flex items-center justify-center gap-2 mb-1">
                            <span class="text-2xl" style="color:${pl.color}">${pl.symbol}</span> ${lang.planets[pl.id]}
                        </h4>
                        <div class="flex justify-center gap-4 text-sm text-slate-600 font-medium">
                            <span>${lang.signs[Math.floor(pl.longitude / 30)]} ${(pl.longitude % 30).toFixed(2)}¬∞</span>
                            <span class="text-slate-300">|</span>
                            <span>House ${hs}</span>
                        </div>
                    `;
                    toast.classList.add('active');
                    
                    // 3ÁßíÂæå„Å´Ëá™Âãï„ÅßÈö†„Åô
                    setTimeout(() => { if(found) toast.classList.remove('active'); }, 4000);
                    break; 
                } 
            }
            if (!found) toast.classList.remove('active');
        }

        // Â§©‰ΩìË®àÁÆó
        function calculateHoroscope() {
            try {
                const d = document.getElementById('targetDate').value, tm = document.getElementById('targetTime').value, o = parseFloat(document.getElementById('timezone').value) || 0, lat = parseFloat(document.getElementById('lat').value), lon = parseFloat(document.getElementById('lon').value);
                if (!d || !tm) return; 
                const utc = new Date(`${d}T${tm}:00Z`).getTime() - (o * 3600000), utcD = new Date(utc), aT = Astronomy.MakeTime(utcD), gmst = Astronomy.SiderealTime(utcD);
                
                const lstR = (gmst + (lon / 15.0)) * 15 * Math.PI / 180, eps = 23.4393 * Math.PI / 180, lR = lat * Math.PI / 180;
                ascendantDeg = (Math.atan2(Math.cos(lstR), -(Math.sin(lstR) * Math.cos(eps) + Math.tan(lR) * Math.sin(eps))) * 180 / Math.PI + 360) % 360;
                
                const getL = (b, t) => { const v = Astronomy.GeoVector(b, t, true), e = 23.4392911 * Math.PI / 180; return (Math.atan2(v.y * Math.cos(e) + v.z * Math.sin(e), v.x) * 180 / Math.PI + 0.0139688 * (t.ut / 365.25) + 360) % 360; };
                
                planetData = PLANET_DEFS.map(p => ({ ...p, longitude: ["Ceres","Pallas","Juno","Vesta","Chiron"].includes(p.id) ? getAsteroidLongitude(p.id, aT) : getL(Astronomy.Body[p.id] || Astronomy.Body.Sun, aT) }));
                
                updateJapanCalendar(aT, getL(Astronomy.Body.Sun, aT)); 
                updateUI(); 
                drawChart();
            } catch (e) { console.error(e); }
        }

        function solveKepler(M, e) { let E = M * Math.PI / 180; for (let i = 0; i < 10; i++) E = E - (E - e * Math.sin(E) - M * Math.PI / 180) / (1 - e * Math.cos(E)); return E; }
        function getAsteroidLongitude(id, t) {
            const el = ASTEROID_ELEMENTS[id]; if (!el) return 0; const n = 0.9856076686 / Math.pow(el.a, 1.5);
            let M = (el.M + n * t.ut + 360) % 360; const E = solveKepler(M, el.e), x = Math.cos(E) - el.e, y = Math.sin(E) * Math.sqrt(1 - el.e * el.e), v = Math.atan2(y, x), r = el.a * (1 - el.e * Math.cos(E)), u = v + el.w * Math.PI / 180, N = el.N * Math.PI / 180, i = el.i * Math.PI / 180;
            const xh = r * (Math.cos(N) * Math.cos(u) - Math.sin(N) * Math.sin(u) * Math.cos(i)), yh = r * (Math.sin(N) * Math.cos(u) + Math.cos(N) * Math.sin(u) * Math.cos(i)), zh = r * (Math.sin(u) * Math.sin(i)), ev = Astronomy.HelioVector(Astronomy.Body.Earth, t);
            return (Math.atan2(yh - ev.y, xh - ev.x) * 180 / Math.PI + 0.0139688 * (t.ut / 365.25) + 360) % 360;
        }

        function updateUI() {
            const t = i18n[currentLang]; 
            document.getElementById('ascendant-overlay').innerText = `ASC: ${t.signs[Math.floor(ascendantDeg / 30)]} ${(ascendantDeg % 30).toFixed(1)}¬∞`;
            
            document.getElementById('planetList').innerHTML = planetData.map(p => `
                <div class="flex justify-between items-center px-4 py-3 hover:bg-slate-50 transition cursor-pointer" onclick="handleListClick('${p.id}')">
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-serif" style="color:${p.color}">${p.symbol}</span>
                        <span class="text-sm font-bold text-slate-700">${t.planets[p.id]}</span>
                    </div>
                    <span class="font-mono text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded">
                        ${t.signs[Math.floor(p.longitude / 30)]} ${(p.longitude % 30).toFixed(1)}¬∞
                    </span>
                </div>
            `).join('');

            let aF = false, aH = '';
            for (let i = 0; i < planetData.length; i++) { 
                for (let j = i + 1; j < planetData.length; j++) { 
                    const p1 = planetData[i], p2 = planetData[j]; 
                    if(["Ceres","Pallas","Juno","Vesta"].includes(p1.id) || ["Ceres","Pallas","Juno","Vesta"].includes(p2.id)) continue; 
                    ASPECT_DEFS.forEach(asp => { 
                        if (!aspectVisibility[asp.id]) return; 
                        const diff = Math.abs(p1.longitude - p2.longitude), orb = Math.abs((diff > 180 ? 360 - diff : diff) - asp.angle); 
                        if (orb <= asp.orb) { 
                            aF = true; 
                            aH += `
                            <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border border-slate-100">
                                <div class="flex -space-x-1">
                                    <span class="text-sm" style="color:${p1.color}">${p1.symbol}</span>
                                    <span class="text-sm" style="color:${p2.color}">${p2.symbol}</span>
                                </div>
                                <div class="flex flex-col leading-none">
                                    <span class="font-bold text-[10px] text-slate-700">${asp.id.substring(0,3)}</span>
                                    <span class="text-[9px] text-slate-400">orb ${orb.toFixed(1)}¬∞</span>
                                </div>
                            </div>`; 
                        } 
                    }); 
                } 
            }
            document.getElementById('aspectResults').innerHTML = aF ? aH : `<p class="text-slate-400 text-xs py-2 col-span-full text-center">${t.noAspects}</p>`;
        }

        // „É™„Çπ„Éà„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„Éè„Ç§„É©„Ç§„ÉàÂá¶ÁêÜÔºàÁ∞°ÊòìÁöÑÔºâ
        function handleListClick(id) {
            // „Çπ„ÇØ„É≠„Éº„É´„Éà„ÉÉ„Éó„Å∏
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // ÂØæË±°„ÅÆÊÉëÊòü„Éá„Éº„Çø„ÇíÊ§úÁ¥¢„Åó„Å¶„Éà„Éº„Çπ„ÉàË°®Á§∫
            const p = planetData.find(pd => pd.id === id);
            if(p) {
                const lang = i18n[currentLang];
                const hs = (Math.floor(p.longitude / 30) - Math.floor(ascendantDeg / 30) + 12) % 12 + 1; 
                const toast = document.getElementById('mobile-info-toast');
                document.getElementById('toast-content').innerHTML = `
                        <h4 class="text-lg font-bold text-slate-800 flex items-center justify-center gap-2 mb-1">
                            <span class="text-2xl" style="color:${p.color}">${p.symbol}</span> ${lang.planets[p.id]}
                        </h4>
                        <div class="flex justify-center gap-4 text-sm text-slate-600 font-medium">
                            <span>${lang.signs[Math.floor(p.longitude / 30)]} ${(p.longitude % 30).toFixed(2)}¬∞</span>
                            <span class="text-slate-300">|</span>
                            <span>House ${hs}</span>
                        </div>
                    `;
                toast.classList.add('active');
                setTimeout(() => { toast.classList.remove('active'); }, 3000);
            }
        }
    </script>
</body>
</html>
