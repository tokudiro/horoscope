<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horoscope Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Astronomy Engine: Â§©‰ΩìË®àÁÆóÁî®„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <!-- Google Fonts: È´òÂìÅË≥™„Å™„Éï„Ç©„É≥„Éà -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #1e293b;
            --color-accent: #b45309;
            --color-bg: #f8fafc;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Noto Sans JP', sans-serif;
        }
        
        body { 
            font-family: var(--font-sans); 
            background-color: var(--color-bg);
            color: var(--color-primary);
            font-weight: 500;
            overflow-x: hidden;
        }
        
        .en-font { font-family: var(--font-serif); }

        /* „Éõ„É≠„Çπ„Ç≥„Éº„Éó„ÇíÊúÄÂ§ßÈôêÂ§ß„Åç„ÅèË°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆË®≠ÂÆö */
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 1100px; 
            aspect-ratio: 1 / 1; 
            cursor: crosshair;
            margin: 0 auto;
        }
        canvas { width: 100%; height: 100%; }
        
        /* UI Elements */
        .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .3s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:checked + .slider:before { transform: translateX(14px); }

        /* Input Styles */
        .header-input-group { position: relative; padding-top: 0.6rem; }
        .header-input-label { position: absolute; top: -0.1rem; left: 0; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; pointer-events: none; }
        .header-input { background: transparent; border: none; border-bottom: 2px solid #cbd5e1; padding: 0.35rem 0; font-size: 1.05rem; font-weight: 700; color: #1e293b; outline: none; transition: border-color 0.2s; }
        .header-input:focus { border-bottom-color: #1e293b; }

        /* Tooltip */
        #tooltip {
            position: fixed;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #94a3b8;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 14px;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            display: none;
            color: #334155;
            min-width: 180px;
            transform: translate(-50%, -110%);
        }
        #tooltip h4 { font-weight: 700; color: #0f172a; margin-bottom: 6px; border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; font-size: 1.1em; }

        .lucky-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .badge-tensha { background-color: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }
        .badge-ichiryu { background-color: #ecfccb; color: #15803d; border: 1px solid #bef264; }
    </style>
</head>
<body class="min-h-screen">

    <div id="tooltip"></div>

    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´Ôºà„Çø„Ç§„É†„Çæ„Éº„É≥„Å®Ë®ÄË™ûË®≠ÂÆö„ÅÆ„ÅøÔºâ -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden border border-slate-100">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 text-lg" id="label-settings-modal">App Settings</h3>
                <button id="closeSettingsBtn" class="text-slate-400 hover:text-slate-700 p-1 rounded-full hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label id="label-tz-modal" class="block text-xs uppercase tracking-widest font-bold text-slate-500 mb-2">Timezone</label>
                    <select id="timezone" class="w-full p-3 border border-slate-300 rounded-lg bg-white outline-none"></select>
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest font-bold text-slate-500 mb-2">Language</label>
                    <button id="langToggle" class="w-full py-3 bg-white border border-slate-300 text-slate-700 font-bold rounded-lg hover:bg-slate-50 shadow-sm">English / Êó•Êú¨Ë™û</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-[1600px] mx-auto p-4 lg:p-6">
        <!-- „Éò„ÉÉ„ÉÄ„Éº„Ç≥„É≥„ÇΩ„Éº„É´ -->
        <header class="mb-6 border-b border-slate-200 pb-6 relative">
            <button id="openSettingsBtn" class="absolute top-0 right-0 p-2 text-slate-400 hover:text-slate-700 transition-colors rounded-full hover:bg-slate-100" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>

            <div class="flex flex-col xl:flex-row xl:items-end justify-between gap-6 pr-12">
                <div class="min-w-fit">
                    <h1 id="ui-title" class="text-4xl md:text-5xl font-bold text-slate-800 tracking-tight en-font">Horoscope Generator</h1>
                    <p id="ui-subtitle" class="text-slate-500 text-sm md:text-base mt-1 tracking-wider font-sans font-medium">Astrological Chart Generator</p>
                </div>
                <div class="flex-grow flex flex-wrap gap-x-8 gap-y-4 items-end">
                    <!-- Êó•ÊôÇË®≠ÂÆö -->
                    <div class="header-input-group flex gap-3 items-end">
                        <label id="label-datetime" class="header-input-label">Date & Time</label>
                        <input type="date" id="targetDate" class="header-input w-36 cursor-pointer">
                        <input type="time" id="targetTime" class="header-input w-28 cursor-pointer">
                        <div class="flex gap-1 mb-1 ml-1">
                            <button id="setNowBtn" class="text-xs text-amber-700 hover:text-amber-900 font-bold uppercase tracking-wider border border-amber-200 px-3 py-1.5 rounded hover:bg-amber-50 transition-colors mb-1 ml-1">Now</button>
                            <button id="togglePlayBtn" class="text-xs text-indigo-700 hover:text-indigo-900 font-bold border border-indigo-200 px-3 py-1.5 rounded hover:bg-indigo-50 transition-colors flex items-center justify-center w-10">
                                <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                <svg id="icon-pause" class="hidden" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Â†¥ÊâÄË®≠ÂÆö -->
                    <div class="flex gap-6 items-end">
                        <div class="header-input-group">
                            <label id="label-city" class="header-input-label">City</label>
                            <select id="citySelect" class="header-input w-40 cursor-pointer"></select>
                        </div>
                        <div class="header-input-group">
                            <label id="label-lat" class="header-input-label">Lat</label>
                            <input type="number" id="lat" step="0.01" class="header-input w-24 text-right" value="35.01">
                        </div>
                        <div class="header-input-group">
                            <label id="label-lon" class="header-input-label">Lon</label>
                            <input type="number" id="lon" step="0.01" class="header-input w-24 text-right" value="135.76">
                        </div>
                    </div>
                    <!-- „Çø„Ç§„É†„Çæ„Éº„É≥Ë°®Á§∫ -->
                    <div class="header-input-group hidden md:block">
                        <label id="label-tz-header" class="header-input-label">Timezone</label>
                        <div class="header-input w-32 text-xs flex items-center text-slate-600 truncate" id="tz-display">
                            (UTC+09:00) Tokyo
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„Éº -->
            <div class="lg:col-span-2 space-y-6 h-fit order-2 lg:order-1">
                <!-- Êó•Êú¨„ÅÆÊö¶ -->
                <div class="bg-white p-4 rounded shadow-sm border border-slate-200">
                    <p id="label-jp-calendar" class="text-xs uppercase tracking-widest font-bold text-slate-500 mb-3 border-b border-slate-100 pb-1">Êó•Êú¨„ÅÆÊö¶</p>
                    <div id="luckyDayArea" class="mb-3 min-h-[1.5rem]"></div>
                    <div class="grid grid-cols-1 gap-y-3 text-sm text-slate-700" id="japanCalendarGrid"></div>
                </div>

                <!-- Ë°®Á§∫Ë®≠ÂÆö -->
                <div class="bg-white p-4 rounded shadow-sm border border-slate-200 no-print-style">
                    <p id="label-settings" class="text-xs uppercase tracking-widest font-bold text-slate-500 mb-4 border-b border-slate-100 pb-1">View Options</p>
                    
                    <div class="mb-5">
                        <label id="label-rotation" class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5">Chart Rotation</label>
                        <select id="rotationSelect" class="w-full p-2 border border-slate-200 rounded text-xs bg-slate-50 outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="aries" selected>Aries 0¬∞ (Natural)</option>
                            <option value="asc">ASC (Ascendant)</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between mb-4">
                        <span id="label-show-asc-line" class="text-xs font-bold text-slate-700">Show ASC Line</span>
                        <label class="switch">
                            <input type="checkbox" id="toggleAscLine" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="aspect-toggles" class="space-y-3 pl-1 border-t border-slate-100 pt-3"></div>
                </div>

                <!-- Â§©‰Ωì‰ΩçÁΩÆ„É™„Çπ„Éà -->
                <div class="bg-white p-4 rounded shadow-sm border border-slate-200">
                    <p id="label-data-header" class="text-xs uppercase tracking-widest font-bold text-slate-700 mb-3 border-b border-slate-100 pb-1">Positions</p>
                    <div id="ascendant-info" class="text-xs font-bold text-indigo-600 mb-2"></div>
                    <div id="planetList" class="text-slate-700 space-y-1 text-xs leading-tight"></div>
                </div>
            </div>

            <!-- „É°„Ç§„É≥„ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢ -->
            <div class="lg:col-span-10 space-y-8 order-1 lg:order-2">
                <div class="bg-white p-2 md:p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center min-h-[600px] overflow-hidden">
                    <div class="chart-container">
                        <canvas id="horoscopeCanvas"></canvas>
                    </div>
                    <!-- „Ç¢„Çπ„Éö„ÇØ„ÉàÁµêÊûú‰∏ÄË¶ß -->
                    <div id="aspectResults" class="w-full mt-6 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-2 text-xs font-medium text-slate-600"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ÂÆöÊï∞„Éª„Éá„Éº„ÇøÂÆöÁæ© ---
        const J_ETO_KAN = ["Áî≤", "‰πô", "‰∏ô", "‰∏Å", "Êàä", "Â∑±", "Â∫ö", "Ëæõ", "Â£¨", "Áô∏"];
        const J_ETO_SHI = ["Â≠ê", "‰∏ë", "ÂØÖ", "ÂçØ", "Ëæ∞", "Â∑≥", "Âçà", "Êú™", "Áî≥", "ÈÖâ", "Êàå", "‰∫•"];
        const J_ROKUYO = ["Â§ßÂÆâ", "Ëµ§Âè£", "ÂÖàÂãù", "ÂèãÂºï", "ÂÖàË≤†", "‰ªèÊªÖ"];
        const J_CHOKU = ["Âª∫", "Èô§", "Ê∫Ä", "Âπ≥", "ÂÆö", "Âü∑", "Á†¥", "Âç±", "Êàê", "Á¥ç", "Èñã", "Èñâ"]; 

        const ELEMENT_COLORS = { Fire: "#fff1f1", Earth: "#f0f9f0", Air: "#fffcf0", Water: "#f0f7ff" };
        const SIGN_ELEMENTS = ["Fire", "Earth", "Air", "Water", "Fire", "Earth", "Air", "Water", "Fire", "Earth", "Air", "Water"];

        const TIMEZONES = [
            { name: "(UTC-08:00) Pacific", offset: -8 }, { name: "(UTC-05:00) Eastern", offset: -5 },
            { name: "(UTC+00:00) London", offset: 0 }, { name: "(UTC+01:00) Paris", offset: 1 }, { name: "(UTC+09:00) Tokyo", offset: 9 },
        ];

        const CITY_DATA = [
            { id: "manual", nameJa: "ÊâãÂãïÂÖ•Âäõ", nameEn: "Manual", lat: null, lon: null },
            { id: "tokyo", nameJa: "Êù±‰∫¨", nameEn: "Tokyo", lat: 35.68, lon: 139.76 },
            { id: "kyoto", nameJa: "‰∫¨ÈÉΩ", nameEn: "Kyoto", lat: 35.01, lon: 135.76 },
            { id: "osaka", nameJa: "Â§ßÈò™", nameEn: "Osaka", lat: 34.69, lon: 135.50 },
            { id: "sapporo", nameJa: "Êú≠Âπå", nameEn: "Sapporo", lat: 43.06, lon: 141.35 },
            { id: "fukuoka", nameJa: "Á¶èÂ≤°", nameEn: "Fukuoka", lat: 33.59, lon: 130.40 }
        ];

        const i18n = {
            ja: {
                title: "Horoscope Generator", subtitle: "Â§©‰ΩìÈÖçÁΩÆÂõ≥„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº",
                labelDateTime: "Êó•ÊôÇ", labelTz: "„Çø„Ç§„É†„Çæ„Éº„É≥", labelSettingsModal: "Ë®≠ÂÆö", labelRotation: "„ÉÅ„É£„Éº„ÉàÂõûËª¢Âü∫Ê∫ñ", labelShowAscLine: "ASC„É©„Ç§„É≥Ë°®Á§∫", labelCity: "ÈÉΩÂ∏Ç", labelLat: "Á∑ØÂ∫¶", labelLon: "ÁµåÂ∫¶", setNow: "ÁèæÂú®", dataHeader: "Â§©‰Ωì‰ΩçÁΩÆ", aspectHeader: "‰∏ª„Å™„Ç¢„Çπ„Éö„ÇØ„Éà", noAspects: "„Ç¢„Çπ„Éö„ÇØ„Éà„Å™„Åó", labelSettings: "Ë°®Á§∫Ë®≠ÂÆö", orb: "Ë®±ÂÆπ", asc: "ASC", labelJpCalendar: "Êó•Êú¨„ÅÆÊö¶", lblKyuureki: "ÊóßÊö¶", lblRokuyo: "ÂÖ≠Êõú", lblEto: "Êó•Âπ≤ÊîØ", lblChoku: "ÂçÅ‰∫åÁõ¥",
                planets: { Sun: "Â§™ÈôΩ", Moon: "Êúà", Mercury: "Ê∞¥Êòü", Venus: "ÈáëÊòü", Mars: "ÁÅ´Êòü", Jupiter: "Êú®Êòü", Saturn: "ÂúüÊòü", Uranus: "Â§©ÁéãÊòü", Neptune: "Êµ∑ÁéãÊòü", Pluto: "ÂÜ•ÁéãÊòü", Ceres: "„Ç±„É¨„Çπ", Pallas: "„Éë„É©„Çπ", Juno: "„Ç∏„É•„Éé„Éº", Vesta: "„Éô„Çπ„Çø", Chiron: "„Ç≠„É≠„É≥" },
                signs: ["Áâ°ÁæäÂ∫ß", "Áâ°ÁâõÂ∫ß", "ÂèåÂ≠êÂ∫ß", "ËüπÂ∫ß", "ÁçÖÂ≠êÂ∫ß", "‰πôÂ•≥Â∫ß", "Â§©Áß§Â∫ß", "Ë†çÂ∫ß", "Â∞ÑÊâãÂ∫ß", "Â±±ÁæäÂ∫ß", "Ê∞¥Áì∂Â∫ß", "È≠öÂ∫ß"],
                aspectNames: { Conjunction: "Âêà(0¬∞)", Opposition: "Ë°ù(180¬∞)", Trine: "‰∏âÂàÜ(120¬∞)", Square: "ÂõõÂàÜ(90¬∞)", Sextile: "ÂÖ≠ÂàÜ(60¬∞)" }
            },
            en: {
                title: "Horoscope Generator", subtitle: "Astrological Chart Generator",
                labelDateTime: "Date & Time", labelTz: "Timezone", labelSettingsModal: "Settings", labelRotation: "Rotation", labelShowAscLine: "Show ASC Line", labelCity: "City", labelLat: "Lat", labelLon: "Lon", setNow: "NOW", dataHeader: "Positions", aspectHeader: "Aspects", noAspects: "None.", labelSettings: "Settings", orb: "orb", asc: "ASC", labelJpCalendar: "J-Calendar", lblKyuureki: "Lunar", lblRokuyo: "Rokuyo", lblEto: "Eto", lblChoku: "Choku",
                planets: { Sun: "Sun", Moon: "Moon", Mercury: "Mercury", Venus: "Venus", Mars: "Mars", Jupiter: "Jupiter", Saturn: "Saturn", Uranus: "Uranus", Neptune: "Neptune", Pluto: "Pluto", Ceres: "Ceres", Pallas: "Pallas", Juno: "Juno", Vesta: "Vesta", Chiron: "Chiron" },
                signs: ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"],
                aspectNames: { Conjunction: "Conj", Opposition: "Opp", Trine: "Trine", Square: "Square", Sextile: "Sextile" }
            }
        };

        let currentLang = 'ja', chartRotationMode = 'aries', showAscLine = true;
        let aspectVisibility = { Conjunction: false, Opposition: false, Trine: false, Square: false, Sextile: false };
        
        const PLANET_DEFS = [
            { id: "Sun", symbol: "‚òâ", color: "#b45309" }, { id: "Moon", symbol: "‚òΩ", color: "#475569" }, 
            { id: "Mercury", symbol: "‚òø", color: "#0f766e" }, { id: "Venus", symbol: "‚ôÄ", color: "#be185d" }, 
            { id: "Mars", symbol: "‚ôÇ", color: "#b91c1c" }, { id: "Ceres", symbol: "‚ö≥", color: "#854d0e" }, 
            { id: "Pallas", symbol: "‚ö¥", color: "#0369a1" }, { id: "Juno", symbol: "‚öµ", color: "#be185d" }, 
            { id: "Vesta", symbol: "‚ö∂", color: "#b91c1c" }, { id: "Jupiter", symbol: "‚ôÉ", color: "#7e22ce" }, 
            { id: "Saturn", symbol: "‚ôÑ", color: "#334155" }, { id: "Chiron", symbol: "‚ö∑", color: "#0f766e" },
            { id: "Uranus", symbol: "‚ôÖ", color: "#0369a1" }, { id: "Neptune", symbol: "‚ôÜ", color: "#1d4ed8" }, 
            { id: "Pluto", symbol: "‚ôá", color: "#1e1b4b" }
        ];

        const ASPECT_DEFS = [
            { id: "Conjunction", angle: 0, orb: 8, color: "#2563eb" }, { id: "Opposition", angle: 180, orb: 8, color: "#dc2626" },
            { id: "Trine", angle: 120, orb: 8, color: "#2563eb" }, { id: "Square", angle: 90, orb: 7, color: "#dc2626" },
            { id: "Sextile", angle: 60, orb: 6, color: "#2563eb" }
        ];

        const ZODIAC_PATHS = ["M12 21V10 M6 9c0 4.5 6 3 6-1 0 4 6 5.5 6 1", "M12 21V10 M12 10a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M5 6c0-3 3-4 7-4s7 1 7 4", "M6 4v16 M18 4v16 M6 4c6 2 12 0 12 0 M6 20c6-2 12 0 12 0", "M6 6c6 0 6 9 0 9s-6-9 0-9 M18 18c-6 0-6-9 0-9s6 9 0 9", "M6 18c0-4 2-6 6-6 4 0 6-3 6-6s-2-4-4-4-3 1-3 3 M18 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4", "M5 6c3 0 3 5 3 5s0-5 3-5 3 5 3 5v7c0 2-2 4-5 0 M14 11c0 3 3 4 4 0", "M5 19h14 M5 15h14 M12 15a4 4 0 0 1 0-8 4 4 0 0 1 0 8", "M6 6v8c0 3 3 3 3 0v-8c0 3 3 3 3 0v8c0 3 3 3 3 0v2l3 3", "M7 17l10-10 M17 7v5 M17 7h-5 M4 20l4-4", "M4 15a3 3 0 0 1 3-3h.5a2.5 2.5 0 0 1 2.5 2.5V17a3.5 3.5 0 0 0 3.5 3.5h.5a3 3 0 0 0 3-3c0-3-2.5-4-5-4v-3a5 5 0 0 0-5-5h-.5a5.5 5.5 0 0 0-5.5 5.5V18", "M4 10l3-3 3 3 3-3 3 3 3-3 M4 16l3-3 3 3 3-3 3 3 3-3", "M6 6c4 4 4 8 0 12 M18 6c-4 4-4 8 0 12 M5 12h14"];
        const ASTEROID_ELEMENTS = { "Ceres": { a: 2.766, e: 0.0758, i: 10.59, N: 80.33, w: 73.51, M: 77.37 }, "Pallas": { a: 2.773, e: 0.231, i: 34.84, N: 173.08, w: 310.05, M: 96.98 }, "Juno": { a: 2.670, e: 0.255, i: 12.97, N: 169.85, w: 248.42, M: 41.53 }, "Vesta": { a: 2.362, e: 0.0886, i: 7.14, N: 103.81, w: 151.20, M: 20.85 }, "Chiron": { a: 13.70, e: 0.383, i: 6.93, N: 209.32, w: 339.56, M: 8.5 } };

        let planetData = [], ascendantDeg = 0, hitZones = [], isPlaying = false, animationFrameId = null, lastTimestamp = 0;

        // --- „É≠„Ç∏„ÉÉ„ÇØÂÆüË£Ö ---
        window.onload = () => {
            const canvas = document.getElementById('horoscopeCanvas');
            initTimezoneSelect(); setNow(); initCitySelect(); renderAspectToggles(); updateStaticLabels(); initRealtimeUpdates();
            function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth * window.devicePixelRatio; canvas.height = canvas.parentElement.clientWidth * window.devicePixelRatio; if (planetData.length > 0) drawChart(); }
            window.addEventListener('resize', resizeCanvas); resizeCanvas();
            canvas.addEventListener('mousemove', handleMouseMove);
            document.getElementById('setNowBtn').onclick = () => { setNow(); calculateHoroscope(); };
            document.getElementById('togglePlayBtn').onclick = togglePlay;
            document.getElementById('langToggle').onclick = toggleLanguage;
            document.getElementById('openSettingsBtn').onclick = () => document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('closeSettingsBtn').onclick = () => document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('timezone').onchange = (e) => { const tz = TIMEZONES.find(t => t.offset == e.target.value); if(tz) document.getElementById('tz-display').innerText = tz.name; calculateHoroscope(); };
            calculateHoroscope();
        };

        function setText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }

        function updateStaticLabels() {
            const t = i18n[currentLang];
            setText('ui-title', t.title); setText('ui-subtitle', t.subtitle); setText('label-datetime', t.labelDateTime); setText('label-tz-header', t.labelTz); setText('label-settings-modal', t.labelSettingsModal); setText('label-rotation', t.labelRotation); setText('label-show-asc-line', t.labelShowAscLine); setText('label-city', t.labelCity); setText('label-lat', t.labelLat); setText('label-lon', t.labelLon); setText('setNowBtn', t.setNow); setText('label-data-header', t.dataHeader); setText('label-settings', t.labelSettings); setText('label-tz-modal', t.labelTz); setText('label-jp-calendar', t.labelJpCalendar);
        }

        function updateJapanCalendar(astroTime, sunLon) {
            const jd = astroTime.ut + 2451545.0, dayIndex = Math.floor(jd + 0.5), etoIdx = (dayIndex + 49) % 60;
            const dayEtoStr = `${J_ETO_KAN[etoIdx % 10]}${J_ETO_SHI[etoIdx % 12]}`;
            let adj = (sunLon - 315 + 360) % 360;
            const setsuIdx = Math.floor(adj / 30);
            const chokuStr = J_CHOKU[(etoIdx % 12 - (setsuIdx + 2) % 12 + 12) % 12];
            const nm = Astronomy.SearchMoonPhase(0, astroTime, -35); if (!nm) return;
            const lDay = Math.floor(astroTime.ut - nm.ut) + 1, lMonth = Math.floor(((Astronomy.SunPosition(nm).elon - 330 + 360) % 360) / 30) + 1;
            let lucky = "";
            const s = Math.floor(setsuIdx / 3); if ((s===0 && dayEtoStr==="ÊàäÂØÖ") || (s===1 && dayEtoStr==="Áî≤Âçà") || (s===2 && dayEtoStr==="ÊàäÁî≥") || (s===3 && dayEtoStr==="Áî≤Â≠ê")) lucky += `<span class="lucky-badge badge-tensha">‚òÖ Â§©Ëµ¶Êó•</span>`;
            const manbaiMap = [["‰∏ë","Âçà"],["ÂØÖ","ÈÖâ"],["Â≠ê","ÂçØ"],["ÂçØ","Ëæ∞"],["Â∑≥","Âçà"],["Âçà","ÈÖâ"],["Â≠ê","Êú™"],["ÂçØ","Áî≥"],["ÈÖâ","Âçà"],["ÈÖâ","Êàå"],["‰∫•","Â≠ê"],["Â≠ê","‰∏ë"]];
            if (manbaiMap[setsuIdx].includes(J_ETO_SHI[etoIdx % 12])) lucky += `<span class="lucky-badge badge-ichiryu">üåæ ‰∏ÄÁ≤í‰∏áÂÄçÊó•</span>`;
            document.getElementById('luckyDayArea').innerHTML = lucky;
            document.getElementById('japanCalendarGrid').innerHTML = `<div class="border-b border-slate-50 pb-1 flex justify-between"><span class="text-[10px] text-slate-400 font-bold uppercase">${i18n[currentLang].lblRokuyo}</span><span class="text-xs font-bold text-slate-800">${J_ROKUYO[(lMonth + lDay) % 6]}</span></div><div class="border-b border-slate-50 pb-1 flex justify-between"><span class="text-[10px] text-slate-400 font-bold uppercase">${i18n[currentLang].lblEto}</span><span class="text-xs font-bold text-slate-800">${dayEtoStr}</span></div><div class="border-b border-slate-50 pb-1 flex justify-between"><span class="text-[10px] text-slate-400 font-bold uppercase">${i18n[currentLang].lblChoku}</span><span class="text-xs font-bold text-slate-800">${chokuStr}</span></div><div class="flex justify-between"><span class="text-[10px] text-slate-400 font-bold uppercase">${i18n[currentLang].lblKyuureki}</span><span class="text-xs font-bold text-slate-800">${lMonth}/${lDay}</span></div>`;
        }

        function drawChart() {
            const canvas = document.getElementById('horoscopeCanvas'), ctx = canvas.getContext('2d');
            const size = canvas.width / window.devicePixelRatio, center = size / 2;
            const outerRadius = size * 0.49, midRadius = outerRadius * 0.93, innerRadius = midRadius * 0.85;
            const t = i18n[currentLang], fontSans = '"Noto Sans JP", sans-serif';
            let rotBase = chartRotationMode === 'asc' ? ascendantDeg * Math.PI / 180 : 0; 
            ctx.clearRect(0, 0, size, size); hitZones = [];

            for (let i = 0; i < 12; i++) {
                const startA = Math.PI - (i * 30 * Math.PI / 180 - rotBase), endA = Math.PI - ((i + 1) * 30 * Math.PI / 180 - rotBase);
                ctx.beginPath(); ctx.moveTo(center, center); ctx.arc(center, center, midRadius, startA, endA, true);
                ctx.fillStyle = ELEMENT_COLORS[SIGN_ELEMENTS[i]]; ctx.fill();
            }
            ctx.beginPath(); ctx.arc(center, center, innerRadius, 0, Math.PI * 2); ctx.fillStyle = "#ffffff"; ctx.fill();

            const pOrder = { "Sun": 0, "Mercury": 1, "Venus": 2, "Moon": 3, "Mars": 4, "Ceres": 4.8, "Pallas": 4.9, "Juno": 5.0, "Vesta": 5.1, "Jupiter": 6, "Saturn": 7, "Chiron": 7.5, "Uranus": 8, "Neptune": 9, "Pluto": 10 };
            const orbMaxR = innerRadius * 0.92, orbMinR = innerRadius * 0.20;
            ctx.lineWidth = 0.5; ctx.strokeStyle = '#f1f5f9'; 
            for (let i = 0; i <= 10; i++) { ctx.beginPath(); ctx.arc(center, center, orbMinR + (i / 10) * (orbMaxR - orbMinR), 0, Math.PI * 2); ctx.stroke(); }

            for (let i = 0; i < 12; i++) {
                const angle = Math.PI - (i * 30 * Math.PI / 180 - rotBase);
                ctx.beginPath(); ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1.2; ctx.moveTo(center + Math.cos(angle) * midRadius, center + Math.sin(angle) * midRadius); ctx.lineTo(center + Math.cos(angle) * (orbMinR * 0.8), center + Math.sin(angle) * (orbMinR * 0.8)); ctx.stroke();
                const midA = Math.PI - ((i * 30 + 15) * Math.PI / 180 - rotBase), hNum = (i - Math.floor(ascendantDeg / 30) + 12) % 12 + 1;
                ctx.save(); ctx.translate(center, center); ctx.rotate(midA + Math.PI / 2);
                ctx.fillStyle = '#1e293b'; ctx.font = `bold 12px ${fontSans}`; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom'; ctx.fillText(`${hNum}:${t.signs[i]}`, 0, -midRadius - 4);
                ctx.translate(0, -(innerRadius + (midRadius - innerRadius)/2)); ctx.scale(1.2, 1.2); ctx.translate(-12, -12);
                ctx.strokeStyle = '#475569'; ctx.lineWidth = 1.5; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.stroke(new Path2D(ZODIAC_PATHS[i])); ctx.restore();
            }

            if (showAscLine) {
                const adA = Math.PI - (ascendantDeg * Math.PI / 180 - rotBase);
                ctx.beginPath(); ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2.5; ctx.moveTo(center + Math.cos(adA) * innerRadius, center + Math.sin(adA) * innerRadius); ctx.lineTo(center + Math.cos(adA + Math.PI) * innerRadius, center + Math.sin(adA + Math.PI) * innerRadius); ctx.stroke();
                ctx.fillStyle = '#ef4444'; ctx.font = `bold 15px ${fontSans}`; ctx.fillText('ASC', center + Math.cos(adA) * (innerRadius + 18), center + Math.sin(adA) * (innerRadius + 18) + 5);
            }

            const mR = innerRadius * 0.98; ctx.globalAlpha = 0.5;
            for (let i = 0; i < planetData.length; i++) { for (let j = i + 1; j < planetData.length; j++) {
                const p1 = planetData[i], p2 = planetData[j]; if(["Ceres","Pallas","Juno","Vesta"].includes(p1.id) || ["Ceres","Pallas","Juno","Vesta"].includes(p2.id)) continue;
                ASPECT_DEFS.forEach(asp => {
                    if (!aspectVisibility[asp.id]) return;
                    const diff = Math.abs(p1.longitude - p2.longitude), orb = Math.abs((diff > 180 ? 360 - diff : diff) - asp.angle);
                    if (orb <= asp.orb) {
                        const a1 = Math.PI - (p1.longitude * Math.PI / 180 - rotBase), a2 = Math.PI - (p2.longitude * Math.PI / 180 - rotBase);
                        ctx.beginPath(); ctx.lineWidth = orb < 1 ? 2 : 1; ctx.strokeStyle = asp.color; ctx.moveTo(center + Math.cos(a1) * mR, center + Math.sin(a1) * mR); ctx.lineTo(center + Math.cos(a2) * mR, center + Math.sin(a2) * mR); ctx.stroke();
                    }
                });
            } } ctx.globalAlpha = 1.0;

            planetData.forEach(p => {
                const angle = Math.PI - (p.longitude * Math.PI / 180 - rotBase);
                const mx = center + Math.cos(angle) * mR, my = center + Math.sin(angle) * mR, sx = center + Math.cos(angle) * (orbMinR + ((pOrder[p.id] || 0) / 10) * (orbMaxR - orbMinR)), sy = center + Math.sin(angle) * (orbMinR + ((pOrder[p.id] || 0) / 10) * (orbMaxR - orbMinR));
                ctx.beginPath(); ctx.strokeStyle = p.color; ctx.lineWidth = 0.5; ctx.setLineDash([2, 3]); ctx.moveTo(mx, my); ctx.lineTo(sx, sy); ctx.stroke(); ctx.setLineDash([]);
                ctx.beginPath(); ctx.fillStyle = p.color; ctx.arc(mx, my, 2.5, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(sx, sy, 13, 0, Math.PI * 2); ctx.fillStyle = "rgba(255,255,255,0.9)"; ctx.fill();
                ctx.fillStyle = p.color; ctx.font = `400 26px ${fontSans}`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(p.symbol, sx, sy);
                hitZones.push({ x: sx, y: sy, r: 16, data: p });
            });
        }

        // --- „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---
        function initTimezoneSelect() { document.getElementById('timezone').innerHTML = TIMEZONES.map(tz => `<option value="${tz.offset}" ${tz.offset === 9 ? 'selected' : ''}>${tz.name}</option>`).join(''); }
        function initRealtimeUpdates() { ['targetDate', 'targetTime', 'lat', 'lon'].forEach(id => document.getElementById(id).addEventListener('input', () => { if (id === 'lat' || id === 'lon') document.getElementById('citySelect').value = "manual"; calculateHoroscope(); })); document.getElementById('rotationSelect').onchange = (e) => { chartRotationMode = e.target.value; drawChart(); }; document.getElementById('toggleAscLine').onchange = (e) => { showAscLine = e.target.checked; drawChart(); }; }
        function initCitySelect() { const s = document.getElementById('citySelect'); updateCityOptions(); s.value = "kyoto"; s.onchange = (e) => { const c = CITY_DATA.find(x => x.id === e.target.value); if (c && c.lat !== null) { document.getElementById('lat').value = c.lat; document.getElementById('lon').value = c.lon; calculateHoroscope(); } }; }
        function updateCityOptions() { document.getElementById('citySelect').innerHTML = CITY_DATA.map(c => `<option value="${c.id}">${currentLang === 'ja' ? c.nameJa : c.nameEn}</option>`).join(''); }
        function renderAspectToggles() { const c = document.getElementById('aspect-toggles'), t = i18n[currentLang]; c.innerHTML = ASPECT_DEFS.map(asp => `<div class="flex items-center justify-between"><span class="text-xs font-bold text-slate-700">${t.aspectNames[asp.id]}</span><label class="switch"><input type="checkbox" id="toggle-${asp.id}" ${aspectVisibility[asp.id] ? 'checked' : ''}><span class="slider"></span></label></div>`).join(''); ASPECT_DEFS.forEach(asp => { document.getElementById(`toggle-${asp.id}`).onchange = (e) => { aspectVisibility[asp.id] = e.target.checked; updateUI(); drawChart(); }; }); }
        function toggleLanguage() { currentLang = currentLang === 'ja' ? 'en' : 'ja'; updateStaticLabels(); updateCityOptions(); renderAspectToggles(); updateUI(); drawChart(); }
        function setNow() { const n = new Date(), o = parseFloat(document.getElementById('timezone').value) || 0, d = new Date(n.getTime() + (o * 3600000)); document.getElementById('targetDate').value = d.toISOString().split('T')[0]; document.getElementById('targetTime').value = d.toISOString().split('T')[1].substring(0, 5); }
        function togglePlay() { isPlaying = !isPlaying; const b = document.getElementById('togglePlayBtn'); if (isPlaying) { b.classList.add('playing-indicator'); document.getElementById('icon-play').classList.add('hidden'); document.getElementById('icon-pause').classList.remove('hidden'); lastTimestamp = performance.now(); animationFrameId = requestAnimationFrame(animate); } else { b.classList.remove('playing-indicator'); document.getElementById('icon-play').classList.remove('hidden'); document.getElementById('icon-pause').classList.add('hidden'); if (animationFrameId) cancelAnimationFrame(animationFrameId); } }
        function animate(t) { if (!isPlaying) return; const d = t - (lastTimestamp || t); lastTimestamp = t; const c = new Date(`${document.getElementById('targetDate').value}T${document.getElementById('targetTime').value}:00Z`).getTime(); if (!isNaN(c)) { const nt = new Date(c + d * 86400); document.getElementById('targetDate').value = nt.toISOString().split('T')[0]; document.getElementById('targetTime').value = nt.toISOString().split('T')[1].substring(0, 5); calculateHoroscope(); } animationFrameId = requestAnimationFrame(animate); }
        function handleMouseMove(e) {
            const c = document.getElementById('horoscopeCanvas'), rect = c.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (c.width / rect.width / window.devicePixelRatio), y = (e.clientY - rect.top) * (c.height / rect.height / window.devicePixelRatio);
            const tt = document.getElementById('tooltip'); let f = false;
            for (const z of hitZones) { if (Math.sqrt((x - z.x)**2 + (y - z.y)**2) <= z.r) { f = true; const pl = z.data, lang = i18n[currentLang]; const hs = (Math.floor(pl.longitude / 30) - Math.floor(ascendantDeg / 30) + 12) % 12 + 1; tt.innerHTML = `<h4>${lang.planets[pl.id]} ${pl.symbol}</h4><p>${lang.signs[Math.floor(pl.longitude / 30)]} ${(pl.longitude % 30).toFixed(2)}¬∞</p><p>Á¨¨${hs}„Éè„Ç¶„Çπ</p>`; tt.style.display = 'block'; tt.style.left = e.clientX + 'px'; tt.style.top = e.clientY + 'px'; break; } }
            if (!f) tt.style.display = 'none';
        }
        function calculateHoroscope() {
            try {
                const d = document.getElementById('targetDate').value, tm = document.getElementById('targetTime').value, o = parseFloat(document.getElementById('timezone').value) || 0, lat = parseFloat(document.getElementById('lat').value), lon = parseFloat(document.getElementById('lon').value);
                if (!d || !tm) return; const utc = new Date(`${d}T${tm}:00Z`).getTime() - (o * 3600000), utcD = new Date(utc), aT = Astronomy.MakeTime(utcD), gmst = Astronomy.SiderealTime(utcD);
                const lstR = (gmst + (lon / 15.0)) * 15 * Math.PI / 180, eps = 23.4393 * Math.PI / 180, lR = lat * Math.PI / 180;
                ascendantDeg = (Math.atan2(Math.cos(lstR), -(Math.sin(lstR) * Math.cos(eps) + Math.tan(lR) * Math.sin(eps))) * 180 / Math.PI + 360) % 360;
                const getL = (b, t) => { const v = Astronomy.GeoVector(b, t, true), e = 23.4392911 * Math.PI / 180; return (Math.atan2(v.y * Math.cos(e) + v.z * Math.sin(e), v.x) * 180 / Math.PI + 0.0139688 * (t.ut / 365.25) + 360) % 360; };
                planetData = PLANET_DEFS.map(p => ({ ...p, longitude: ["Ceres","Pallas","Juno","Vesta","Chiron"].includes(p.id) ? getAsteroidLongitude(p.id, aT) : getL(Astronomy.Body[p.id] || Astronomy.Body.Sun, aT) }));
                updateJapanCalendar(aT, getL(Astronomy.Body.Sun, aT)); updateUI(); drawChart();
            } catch (e) { console.error(e); }
        }
        function solveKepler(M, e) { let E = M * Math.PI / 180; for (let i = 0; i < 10; i++) E = E - (E - e * Math.sin(E) - M * Math.PI / 180) / (1 - e * Math.cos(E)); return E; }
        function getAsteroidLongitude(id, t) {
            const el = ASTEROID_ELEMENTS[id]; if (!el) return 0; const n = 0.9856076686 / Math.pow(el.a, 1.5);
            let M = (el.M + n * t.ut + 360) % 360; const E = solveKepler(M, el.e), x = Math.cos(E) - el.e, y = Math.sin(E) * Math.sqrt(1 - el.e * el.e), v = Math.atan2(y, x), r = el.a * (1 - el.e * Math.cos(E)), u = v + el.w * Math.PI / 180, N = el.N * Math.PI / 180, i = el.i * Math.PI / 180;
            const xh = r * (Math.cos(N) * Math.cos(u) - Math.sin(N) * Math.sin(u) * Math.cos(i)), yh = r * (Math.sin(N) * Math.cos(u) + Math.cos(N) * Math.sin(u) * Math.cos(i)), zh = r * (Math.sin(u) * Math.sin(i)), ev = Astronomy.HelioVector(Astronomy.Body.Earth, t);
            return (Math.atan2(yh - ev.y, xh - ev.x) * 180 / Math.PI + 0.0139688 * (t.ut / 365.25) + 360) % 360;
        }
        function updateUI() {
            const t = i18n[currentLang]; setText('ascendant-info', `${t.asc}: ${t.signs[Math.floor(ascendantDeg / 30)]} ${(ascendantDeg % 30).toFixed(2)}¬∞`);
            document.getElementById('planetList').innerHTML = planetData.map(p => `<div class="flex justify-between border-b border-slate-50 pb-0.5"><span>${p.symbol} ${t.planets[p.id]}</span><span class="font-mono text-[10px] text-slate-500">${t.signs[Math.floor(p.longitude / 30)]} ${(p.longitude % 30).toFixed(1)}¬∞</span></div>`).join('');
            let aF = false, aH = `<p class="col-span-full font-bold border-b border-slate-100 pb-1 mb-1 uppercase text-[10px] text-slate-400">${t.aspectHeader}</p>`;
            for (let i = 0; i < planetData.length; i++) { for (let j = i + 1; j < planetData.length; j++) { const p1 = planetData[i], p2 = planetData[j]; if(["Ceres","Pallas","Juno","Vesta"].includes(p1.id) || ["Ceres","Pallas","Juno","Vesta"].includes(p2.id)) continue; ASPECT_DEFS.forEach(asp => { if (!aspectVisibility[asp.id]) return; const diff = Math.abs(p1.longitude - p2.longitude), orb = Math.abs((diff > 180 ? 360 - diff : diff) - asp.angle); if (orb <= asp.orb) { aF = true; aH += `<div class="flex justify-between items-center text-[10px]"><span class="truncate"><span style="color:${p1.color}">${p1.symbol}</span> ${asp.id.substring(0,3)} <span style="color:${p2.color}">${p2.symbol}</span></span><span class="text-slate-400">${orb.toFixed(1)}¬∞</span></div>`; } }); } }
            document.getElementById('aspectResults').innerHTML = aF ? aH : `<p class="text-slate-300 italic text-center col-span-full py-2">${t.noAspects}</p>`;
        }
    </script>
</body>
</html>
